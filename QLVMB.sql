USE MASTER
DROP DATABASE IF EXISTS QLVMB
CREATE DATABASE QLVMB
USE QLVMB
GO

CREATE TABLE THAMSO (
	SoSanBayTGToiDa TINYINT NOT NULL,
	TGBayToiThieu TIME NOT NULL,
	TGDungToiThieu TIME NOT NULL,
	TGDungToiDa TIME NOT NULL,
	TGDatVeChamNhat TINYINT NOT NULL,
	TGHuyChamNhat TINYINT NOT NULL,
)

CREATE TABLE NHOMNGUOIDUNG (
	MaNhom CHAR(1) PRIMARY KEY,
	TenNhom NVARCHAR(100) NOT NULL
)

CREATE TABLE NGUOIDUNG (
	MaDangNhap CHAR(15) PRIMARY KEY,
	MatKhau NVARCHAR(255) NOT NULL,
	MaNhom CHAR(1) NOT NULL FOREIGN KEY REFERENCES NHOMNGUOIDUNG(MaNhom),
	TenNguoiDung NVARCHAR(150) NOT NULL,
	DinhDanh VARCHAR(20),
	SoDienThoai VARCHAR(15) NOT NULL,
	Email VARCHAR(255),
	NgaySinh DATETIME2 NOT NULL
)

CREATE TABLE SANBAY (
	MaSanBay CHAR(10) PRIMARY KEY, 
	TenSanBay NVARCHAR(50) NOT NULL
)

CREATE TABLE CHUYENBAY (
	MaChuyenBay CHAR(10) PRIMARY KEY,
	MaSanBayDi CHAR(10) FOREIGN KEY REFERENCES SANBAY(MaSanBay) NOT NULL,
	MaSanBayDen CHAR(10) FOREIGN KEY REFERENCES SANBAY(MaSanBay) NOT NULL,
	NgayGioBay DATETIME2 NOT NULL,
	ThoiGianBay TIME NOT NULL,
	GiaCoBan MONEY NOT NULL
)

CREATE TABLE TRUNGGIAN (
	MaSanBay CHAR(10) REFERENCES SANBAY(MaSanBay) NOT NULL,
	MaChuyenBay CHAR(10) REFERENCES CHUYENBAY(MaChuyenBay) NOT NULL,
	ThoiGianDung TIME	NOT NULL, 
	GhiChu NTEXT,

	PRIMARY KEY (MaSanBay, MaChuyenBay)
)

CREATE TABLE HANGVE (
	MaHangVe CHAR(10) PRIMARY KEY,
	TenHangVe NVARCHAR(50) NOT NULL,
	TiLeGiaVe FLOAT NOT NULL
)

CREATE TABLE CT_HANGVE (
	MaHangVe CHAR(10) FOREIGN KEY REFERENCES HANGVE(MaHangVe),
	MaChuyenBay CHAR(10) FOREIGN KEY REFERENCES CHUYENBAY(MaChuyenBay),
	SoLuong SMALLINT NOT NULL

	PRIMARY KEY (MaHangVe, MaChuyenBay)
)

CREATE TABLE BANVE (
	MaChuyenBay CHAR(10) FOREIGN KEY REFERENCES CHUYENBAY(MaChuyenBay),
	MaHangVe CHAR(10) FOREIGN KEY REFERENCES HANGVE(MaHangVe),
	NgayLap DATETIME2 NOT NULL,
	TenKhachHang NVARCHAR(150) NOT NULL,
	DinhDanh VARCHAR(20) NOT NULL,
	SoDienThoai VARCHAR(15) NOT NULL,
	Email VARCHAR(255) NOT NULL,
	primary key(DinhDanh, MaChuyenBay)
)

CREATE TABLE CT_DATVE (
	MaChuyenBay CHAR(10) NOT NULL,
	MaNguoiDat CHAR(15) FOREIGN KEY REFERENCES NGUOIDUNG(MaDangNhap),
	MaHangVe CHAR(10) FOREIGN KEY REFERENCES HANGVE(MaHangVe),
	NgayLap DATETIME2 NOT NULL,
	TinhTrang NVARCHAR(25) NOT NULL,

	CONSTRAINT fk_MaChuyenBay_ctdv 
	FOREIGN KEY (MaChuyenBay)
	REFERENCES CHUYENBAY(MaChuyenBay)
	ON DELETE CASCADE
)

CREATE UNIQUE NONCLUSTERED INDEX idx_MaNguoiDat_when_notnull
ON CT_DATVE(MaNguoiDat, MaChuyenBay)
WHERE MaNguoiDat IS NOT NULL;

CREATE TRIGGER chk_CHUYENBAY
ON CHUYENBAY
FOR UPDATE, DELETE
AS
BEGIN
	IF EXISTS(
		SELECT *
		FROM deleted
		JOIN CT_DATVE ctdv ON ctdv.MaChuyenBay = deleted.MaChuyenBay
	) 
	BEGIN
		PRINT 'ERROR'
		ROLLBACK TRAN
	END
END

INSERT INTO NHOMNGUOIDUNG VALUES ('0', N'Quản trị viên')
INSERT INTO NHOMNGUOIDUNG VALUES ('1', N'Nhân viên')
INSERT INTO NHOMNGUOIDUNG VALUES ('2', N'Khách hàng')

-- username: admin 
-- password: admin
-- Admin
INSERT INTO NGUOIDUNG VALUES ('admin', 'C7AD44CBAD762A5DA0A452F9E854FDC1E0E7A52A38015F23F3EAB1D80B931DD472634DFAC71CD34EBC35D16AB7FB8A90C81F975113D6C7538DC69DD8DE9077EC', 0, 'Admin', '123456789012', '0123456789', 'admin@admin.com', '2001-01-01')

-- username: staff
-- password: staff
-- Staff
INSERT INTO NGUOIDUNG VALUES ('staff', '9040A19CE8ACEE009516B4EA917066E06A5DEB15F5879C5645BF3E9B7C8877E512BE42BCCDC08B2370194D9427ADCF1855FCE60036FA73F689A281D898FB1A48', 1, 'Staff', '123456789011', '0444444444', 'email@gmail.com', '2002-01-01');

-- username: chiton
-- password: sumanila
-- User
INSERT INTO NGUOIDUNG VALUES ('chiton', '0D18B9F90E0FCD443655DB6144E886D457D82C07C232BCABF26600D0456932C6473BA6AE2DC6A7272B2D568025C759E98D9E9E68DE6BF48ABA5209E303C03980', 2, N'Chí Tôn', '712631263213', '0732123124', 'chiton12@gmail.com', '1995-10-12');

-- username: namjoker1996
-- password: sinhvienbachkhoa
-- User
INSERT INTO NGUOIDUNG VALUES ('namjoker1996', '33C7CC9A3CC957332EB225E18C60E6A3A5BA30D7E36FA1AB58EA159B281215939171B75B3B8923D06B0D7C8AC349E2D0C5B15788F949610D34D34FF30B03B00A', 2, N'Nguyễn Nguyên Nhật Nam', '067988687786', '0988241555', 'nạmoker1996@gmail.com', '1996-01-10');

-- username: quansky
-- password: skychinhhieu2209 
-- User
INSERT INTO NGUOIDUNG VALUES ('quansky', '76129EA55B2C28DB05857247ED246B6F975B39AEAE8E7A0193BA84B8F44055FA23EE61D0BB3BB3A8AB16D8F2E2F97D0A563BD6734434DCBA28F1ACA41F58621C', 2, N'Lê Trường Quân', '128264243435', '0238974328', 'quansky2209@gmail.com', '1990-02-01')

-- username: khabaton97
-- password: truongtonbakha1997
-- User
INSERT INTO NGUOIDUNG VALUES ('khabaton97', '83FE5A1FA43570EF4D8D39BEFB024EBCCEDE9B74BCD3562F815E395602D507CF34F9533A3A60D50CC0B897FC78ACE2A98CB190D0D53DC101DB775EE9F4613E56', 2, N'Vũ Minh Trường', '123647324599', '0973273432', 'tonbakhaminhtruong@gmail.com', '1997-12-26')

INSERT INTO SANBAY VALUES ('SGN', N'Tân Sơn Nhất');
INSERT INTO SANBAY VALUES ('HAN', N'Nội Bài');
INSERT INTO SANBAY VALUES ('VII', N'Vinh');
INSERT INTO SANBAY VALUES ('PQC', N'Phú Quốc');

INSERT INTO CHUYENBAY VALUES ('HNSG334', 'HAN', 'SGN', '2023-01-25 23:00:00', '02:00:00', 40000);
INSERT INTO CHUYENBAY VALUES ('HNSG335', 'HAN', 'PQC', '2023-01-25 15:00:00', '02:45:00', 50000);
INSERT INTO CHUYENBAY VALUES ('HNSG336', 'HAN', 'SGN', '2023-01-26 01:00:00', '02:00:00', 60000);
INSERT INTO CHUYENBAY VALUES ('SGVI001', 'SGN', 'VII', '2023-01-27 23:00:00', '02:00:00', 80000);
INSERT INTO CHUYENBAY VALUES ('HNPQ033', 'HAN', 'PQC', '2023-01-31 03:00:00', '02:00:00', 80000);
INSERT INTO CHUYENBAY VALUES ('HNVI001', 'HAN', 'VII', '2023-01-24 00:00:00', '00:20:00', 10000);
INSERT INTO CHUYENBAY VALUES ('SGVI556', 'SGN', 'VII', '2023-01-30 12:00:00', '01:20:00', 70000);
INSERT INTO CHUYENBAY VALUES ('VIPQ112', 'VII', 'PQC', '2022-12-27 00:30:00', '01:50:00', 20000);
INSERT INTO CHUYENBAY VALUES ('SGHN333', 'SGN', 'HAN', '2022-12-22 15:00:00', '02:00:00', 20000);
INSERT INTO CHUYENBAY VALUES ('SGHN223', 'SGN', 'HAN', '2022-12-23 01:00:00', '02:00:00', 80000);
INSERT INTO CHUYENBAY VALUES ('VISG523', 'VII', 'SGN', '2022-12-23 18:00:00', '01:30:00', 80000);
INSERT INTO CHUYENBAY VALUES ('HNSG111', 'HAN', 'SGN', '2020-12-31 13:00:00', '02:00:00', 30000);
INSERT INTO CHUYENBAY VALUES ('HNSG088', 'HAN', 'SGN', '2020-11-10 03:00:00', '02:00:00', 30000);
INSERT INTO CHUYENBAY VALUES ('SGVI356', 'SGN', 'VII', '2020-10-30 12:00:00', '01:20:00', 70000);
INSERT INTO CHUYENBAY VALUES ('PQSG033', 'PQC', 'SGN', '2020-10-10 21:00:00', '01:00:00', 35000);
INSERT INTO CHUYENBAY VALUES ('HNSG121', 'HAN', 'PQC', '2021-01-25 15:00:00', '02:45:00', 50000);
INSERT INTO CHUYENBAY VALUES ('HNSG133', 'HAN', 'SGN', '2021-06-02 01:00:00', '02:00:00', 60000);
INSERT INTO CHUYENBAY VALUES ('HNPQ001', 'HAN', 'PQC', '2021-01-31 03:00:00', '02:00:00', 80000);
INSERT INTO CHUYENBAY VALUES ('PQVI003', 'PQC', 'VII', '2021-06-23 12:00:00', '02:00:00', 75000);
INSERT INTO CHUYENBAY VALUES ('VIPQ012', 'VII', 'PQC', '2022-03-15 00:30:00', '01:50:00', 20000);
INSERT INTO CHUYENBAY VALUES ('SGHN112', 'SGN', 'HAN', '2022-09-22 15:00:00', '02:00:00', 20000);
INSERT INTO CHUYENBAY VALUES ('SGHN122', 'SGN', 'HAN', '2022-07-24 01:00:00', '02:00:00', 80000);
INSERT INTO CHUYENBAY VALUES ('VISG133', 'VII', 'SGN', '2022-11-23 18:00:00', '01:30:00', 80000);

INSERT INTO TRUNGGIAN VALUES ('VII', 'HNSG334', '00:16', '')
INSERT INTO TRUNGGIAN VALUES ('SGN', 'HNSG335', '00:16', '')
INSERT INTO TRUNGGIAN VALUES ('SGN', 'VIPQ012', '00:20', '')
INSERT INTO TRUNGGIAN VALUES ('VII', 'HNSG088', '00:20', '')
INSERT INTO TRUNGGIAN VALUES ('SGN', 'PQVI003', '00:18', '')

INSERT INTO HANGVE VALUES ('HANG1', N'Hạng 1', 1)
INSERT INTO HANGVE VALUES ('HANG2', N'Hạng 2', 1.05)

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG334', 60);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG334', 20);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG335', 60);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG335', 20);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG336', 60);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG336', 20);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGVI001', 50);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGVI001', 20);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNPQ033', 50);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNPQ033', 40);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNVI001', 10);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNVI001', 80);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGVI556', 70);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGVI556', 30);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'VIPQ112', 50);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'VIPQ112', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGHN333', 50);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGHN333', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGHN223', 10);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGHN223', 90);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'VISG523', 30);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'VISG523', 70);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG111', 100);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG111', 0);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG088', 0);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG088', 90);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG121', 30);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG121', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNSG133', 40);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNSG133', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'HNPQ001', 60);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'HNPQ001', 30);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'PQVI003', 50);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'PQVI003', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGVI356', 60);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGVI356', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'PQSG033', 60);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'PQSG033', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'VIPQ012', 90);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'VIPQ012', 20);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGHN112', 20);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGHN112', 70);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'SGHN122', 50);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'SGHN122', 50);

INSERT INTO CT_HANGVE VALUES ('HANG1', 'VISG133', 40);
INSERT INTO CT_HANGVE VALUES ('HANG2', 'VISG133', 50);

INSERT INTO THAMSO VALUES (2, '00:30:00', '00:10:00', '00:20:00', 1, 1);

INSERT INTO CT_DATVE VALUES ('VISG133', 'quansky', 'HANG1', '2022-11-09', 'Done')
INSERT INTO CT_DATVE VALUES ('VISG133', 'khabaton97',  'HANG1', '2022-11-08', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG088', 'namjoker1996',  'HANG2', '2020-10-20', 'Done')
INSERT INTO CT_DATVE VALUES ('HNPQ001', 'chiton', 'HANG1', '2021-01-01', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG133', 'chiton', 'HANG2', '2021-05-21', 'Done')
INSERT INTO CT_DATVE VALUES ('PQSG033', 'quansky', 'HANG2', '2020-09-10', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG111', 'quansky', 'HANG1', '2020-12-11', 'Done')
INSERT INTO CT_DATVE VALUES ('PQVI003', 'namjoker1996', 'HANG2', '2021-05-06', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG133', 'khabaton97', 'HANG2', '2021-05-22', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG336', 'khabaton97', 'HANG1', '2022-12-20', 'Done')
INSERT INTO CT_DATVE VALUES ('SGHN333', 'chiton', 'HANG2', '2022-10-10', 'Done')
INSERT INTO CT_DATVE VALUES ('VIPQ112', 'quansky', 'HANG1', '2022-11-23', 'Done')
INSERT INTO CT_DATVE VALUES ('VIPQ112', 'chiton', 'HANG1', '2022-11-22', 'Done')
INSERT INTO CT_DATVE VALUES ('SGHN223', 'namjoker1996', 'HANG2', '2022-12-19', 'Done')
INSERT INTO CT_DATVE VALUES ('SGHN223', Null, 'HANG1', '2022-12-18', 'Done')
INSERT INTO CT_DATVE VALUES ('SGHN223', Null, 'HANG1', '2022-12-18', 'Done')
INSERT INTO CT_DATVE VALUES ('SGHN223', Null, 'HANG1', '2022-12-18', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG111', Null, 'HANG2', '2020-12-01', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG111', Null, 'HANG1', '2020-12-01', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG111', Null, 'HANG2', '2020-12-01', 'Done')
INSERT INTO CT_DATVE VALUES ('PQVI003', Null, 'HANG2', '2021-05-06', 'Done')
INSERT INTO CT_DATVE VALUES ('PQVI003', Null, 'HANG2', '2021-05-06', 'Done')
INSERT INTO CT_DATVE VALUES ('PQSG033', Null, 'HANG1', '2020-09-10', 'Done')
INSERT INTO CT_DATVE VALUES ('PQSG033', Null, 'HANG2', '2020-09-10', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG133', Null, 'HANG2', '2021-05-20', 'Done')
INSERT INTO CT_DATVE VALUES ('HNSG133', Null, 'HANG2', '2021-05-20', 'Done')

INSERT INTO BANVE VALUES ('SGHN223', 'HANG1', '2022-12-18', N'Nguyễn Long', '088623463721', '0762346112', 'longnguyen@gmail.com')
INSERT INTO BANVE VALUES ('SGHN223', 'HANG1', '2022-12-18', N'Vũ Hoàng Nhật', '063456564573', '0675757545', 'nhatvuhoang@gmail.com')
INSERT INTO BANVE VALUES ('SGHN223', 'HANG1', '2022-12-18', N'Trương Thị Dung', '034552356465', '0723446562', 'dungtruong90@gmail.com')
INSERT INTO BANVE VALUES ('HNSG111', 'HANG1', '2020-12-01', N'Lê Chí Nam', '032874533123', '0219846412', 'namchile@gmail.com')
INSERT INTO BANVE VALUES ('HNSG111', 'HANG1', '2020-12-01', N'Quách Tiến Cường', '076856533125', '0346366412', 'cuongquach@gmail.com')
INSERT INTO BANVE VALUES ('HNSG111', 'HANG2', '2020-12-01', N'Nguyễn Thu Xuân', '036454531122', '0186423555', 'xuanthu@gmail.com')
INSERT INTO BANVE VALUES ('PQVI003', 'HANG2', '2021-05-06', N'Tạ Quốc Cường', '123454234645', '0794659533', 'cuongta96@gmail.com')
INSERT INTO BANVE VALUES ('PQVI003', 'HANG2', '2021-05-06', N'Hà Minh Khang', '446564562345', '0345345634', 'khangminhha@gmail.com')
INSERT INTO BANVE VALUES ('PQSG033', 'HANG1', '2020-09-10', N'Nguyễn Ngọc Ngạn', '123123383443', '0921732144', 'nganyeulan92@gmail.com')
INSERT INTO BANVE VALUES ('PQSG033', 'HANG1', '2020-09-10', N'Mai Thế Tùng', '145435523423', '0236543364', 'tungmai99@gmail.com')
INSERT INTO BANVE VALUES ('HNSG133', 'HANG2', '2021-05-20', N'Hà Đức Chung', '012974723434', '0323865433', 'chunghaduccoder@gmail.com')
INSERT INTO BANVE VALUES ('HNSG133', 'HANG2', '2021-05-20', N'Nguyễn Tiến Bình', '345346457674', '0346250235', 'binhnguyencoder@gmail.com')


